<template>
  <PurpleDotsLoader v-if="load" />

  <!-- Main Page component where the layout and page structure are set -->
  <main-page v-else ref="page" :isFlipped="isFlipped" :mainPage="$t('risk.risk_mngt')"
    :mainSubPage="$t('vulnerability.vulnerability_mngt')" :subPage="$t('vulnerability.vulnerability')"
    :titlePage="$t('vulnerability.vulnerability')" v-permission:show :showInsightsTab="true">

    <div v-permission:update v-permission:delete></div>

    <!-- Statistics Slot - Displays in the "Insights" tab -->
    <template #statistics>
      <div class="statistics-content">
        <!-- Metrics Cards Row -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="metric-card-new rtl">
              <div class="metric-icon-circle bg-gray">
                <i class="fas fa-minus"></i>
              </div>
              <div class="metric-details">
                <h3 class="metric-number">{{ statisticsData.totalVulnerabilities || 0 }}</h3>
                <p class="metric-title">{{ $t("vulnerability.overview_vulnerabilities") || "Overview Vulnerabilities" }}</p>
                <span class="metric-change" :class="statisticsData.totalChange >= 0 ? 'positive' : 'negative'">
                  {{ statisticsData.totalChange >= 0 ? '+' : '' }}{{ statisticsData.totalChangePercent || 0 }}%
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card-new rtl">
              <div class="metric-icon-circle bg-green">
                <i class="fas fa-check"></i>
              </div>
              <div class="metric-details">
                <h3 class="metric-number text-green">{{ statisticsData.closedVulnerabilities || 0 }}</h3>
                <p class="metric-title">{{ $t("vulnerability.closed_vulnerabilities") || "Closed Vulnerabilities" }}</p>
                <span class="metric-change positive">
                  +{{ statisticsData.closedChangePercent || 0 }}%
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card-new rtl">
              <div class="metric-icon-circle bg-red">
                <i class="fas fa-times"></i>
              </div>
              <div class="metric-details">
                <h3 class="metric-number text-red">{{ statisticsData.openVulnerabilities || 0 }}</h3>
                <p class="metric-title">{{ $t("vulnerability.open_vulnerabilities") || "Open Vulnerabilities" }}</p>
                <span class="metric-change negative">
                  +{{ statisticsData.openChangePercent || 0 }}%
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="metric-card-new rtl">
              <div class="metric-icon-circle bg-light-gray">
                <i class="fas fa-box"></i>
              </div>
              <div class="metric-details">
                <h3 class="metric-number text-gray">{{ statisticsData.inProgressVulnerabilities || 0 }}</h3>
                <p class="metric-title">{{ $t("vulnerability.in_progress_vulnerabilities") || "In Progress Vulnerabilities" }}</p>
                <span class="metric-change" :class="statisticsData.inProgressChange >= 0 ? 'positive' : 'negative'">
                  {{ statisticsData.inProgressChange >= 0 ? '+' : '' }}{{ statisticsData.inProgressChangePercent || 0 }}%
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="row">
          <!-- Critical Vulnerabilities by Team (Column Chart) -->
          <div class="col-md-6 mb-4">
            <div class="chart-container">
              <h6 class="chart-title">
                {{ $t("vulnerability.critical_by_team") || "Critical Vulnerabilities by Team" }}
              </h6>
              <highcharts :options="criticalByDepartmentHighcharts"></highcharts>
            </div>
          </div>

          <!-- Top Priority Vulnerabilities (Horizontal Bar Chart) -->
          <div class="col-md-6 mb-4">
            <div class="chart-container">
              <h6 class="chart-title">
                {{ $t("vulnerability.top_priority") || "Top Priority Vulnerabilities" }}
              </h6>
              <highcharts :options="topPriorityHighcharts"></highcharts>
            </div>
          </div>

          <!-- Vulnerability Statistics by Severity and Status (Stacked Column) -->
          <div class="col-12 mb-4">
            <div class="chart-container">
              <h6 class="chart-title">
                {{ $t("vulnerability.severity_status_distribution") || "Vulnerability Statistics by Severity and Status" }}
              </h6>
              <highcharts :options="severityStatusHighcharts"></highcharts>
            </div>
          </div>

          <!-- Vulnerability Closure Rate Over Last 3 Months (Area Spline Chart) -->
          <div class="col-12 mb-4">
            <div class="chart-container">
              <h6 class="chart-title">
                {{ $t("vulnerability.closure_rate_3months") || "Vulnerability Closure Rate Over Last 3 Months" }}
              </h6>
              <highcharts :options="closureRateHighcharts"></highcharts>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Slot for rendering the DataTable -->
    <template #datatable>

      <DataTable ref="table" id="example-table" :tableClass="'table table-striped table-bordered'"
        :showImportDropdown="true" v-permission:show :columns="tableColumns" :api="api" :apiParams="apiParams"
        :editItem="editItem" :openForm="openForm" @qualys-import="handleQualysImport" :filters="vulnerabilityFilters">

        <!-- Customizing the display of the 'Name' column in the table -->
        <template #scanner_status="{ item }">
          {{ item.scanner_status || "N/A" }}</template>

        <template #asset="{ item }">
          <span class="title_span">{{ item?.asset?.name }}</span>
        </template>

        <template #plugin_id="{ item }">
          <span class="title_span"> {{ item?.plugin_id }} </span>
        </template>

        <template #ip_address="{ item }">
          <span class="title_span"> {{ item?.ip_address }} </span>
        </template>

        <template #exploit="{ item }">
          <span v-if="item.exploit === true" class="exploit exploited">{{
            $t("vulnerability.exploit") }}</span>
          <span v-else-if="item.exploit === false" class="exploit not-exploited">
            {{ $t("vulnerability.not_exploit") }}</span>
        </template>

        <template #severity="{ item }">
          <span :class="getSeverityClass(item.severity)">
            {{ getSeverityLabel(item.severity) }}
          </span>
        </template>

        <template #owner_status="{ item }">
          <span :class="getOwnerStatusClass(item.owner_status)" @click.prevent="handleOwnerStatusClick(item)">
            {{ getOwnerStatusLabel(item.owner_status) }}
          </span>
        </template>

        <template #addAction="{ item }">
          <v-list-item v-anyPermission="['view']" @click="setVulnerabilityData(item)" class="action-list-item">
            <template v-slot:prepend>
              <v-icon size="18" class="action-icon"> mdi-eye-outline </v-icon>
            </template>
            <v-list-item-title class="action-title">
              {{ $t("common.view") }}
            </v-list-item-title>
          </v-list-item>
        </template>
      </DataTable>
    </template>

    <!-- Slot for rendering the form -->
    <template #form>
      <Form :schema="fromFields" :newItem="newItem" :api="api" :closeForm="closeForm" :formData="true">
        <template #asset_id="{ item }">
          <div class="col-md-6 mb-3">
            <label for="assignTypeInput">{{ $t("asset.asset") }}</label>
            <v-select label="name" :rules="[required]" :options="assets" v-model="newItem.asset_id"
              :reduce="(option) => option.id" @update:modelValue="" :clearable="true"
              :placeholder="$t('vulnerability.select_asset')" />
          </div>
        </template>
      </Form>
    </template>
  </main-page>

  <!-- change owner status modal -->
  <v-dialog v-model="changeOwnerStatusModal" max-width="700">
    <v-card>
      <v-card-title class="d-flex justify-space-between align-center">
        <span>{{ $t("vulnerability.change_owner_status") }}</span>
        <v-btn icon @click="changeOwnerStatusModal = false">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </v-card-title>
      <v-card-text>
        <v-container class="mb-5">
          <v-select label="name" :options="statusOptions" v-model="vulnerabilityOwnerStatus.owner_status"
            :reduce="(option) => option.id" @update:modelValue="" />
        </v-container>
      </v-card-text>
      <v-card-actions>
        <v-spacer></v-spacer>
        <v-btn color="success" @click="changeOwnerStatus(vulnerabilityOwnerStatus)">{{ $t("common.save")
        }}</v-btn>
        <v-btn color="blue darken-1" text @click="changeOwnerStatusModal = false">{{ $t("common.cancel") }}</v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>

  <!-- View Vulnerability Modal -->
  <ViewVulnerability :viewModal="viewModal" :vulnerabilityData="vulnerabilityData" @close="viewModal = false"
    :formatDate="formatDateShort" :stripHtml="htmlToTextRegex" :teams="teams" @update:viewModal="viewModal = $event" />
</template>

<script>
// Importing necessary components and API modules
import vulnerability from "@/API/Vulnerability/Vulnerability";
import Form from "@/components/Form.vue";
import MainPage from "@/components/MainPage.vue";
import DataTable from "@/components/DataTable.vue";
import Asset from "@/API/Asset/Asset";
import Team from "@/API/Team/Team";
import hostRegion from "@/API/hostRegion/hostRegion";
import assetCategory from "@/API/assetCategory/assetCategory";
import vSelect from "vue-select";
import "vue-select/dist/vue-select.css";
import { toValue, ref } from "vue";
import ViewVulnerability from "./components/ViewVulnerability.vue";
import { formatDateShort, htmlToTextRegex } from "@/utils/helpers";
import PurpleDotsLoader from "@/components/PurpleDotsLoader.vue";
import Highcharts from "highcharts";
import "highcharts/highcharts-more";
import "highcharts/modules/solid-gauge";
import { Chart } from "highcharts-vue";

// Configure Highcharts global options
Highcharts.setOptions({
  lang: {
    decimalPoint: ".",
    thousandsSep: ",",
    numericSymbols: ["k", "M", "G", "T", "P", "E"],
  },
  credits: {
    enabled: false,
  },
  chart: {
    style: {
      fontFamily: "'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
    },
  },
});

export default {
  components: {
    MainPage,
    Form,
    DataTable,
    vSelect,
    ViewVulnerability,
    PurpleDotsLoader,
    highcharts: Chart,
  },

  setup() {
    const api = new vulnerability();
    const apiParams = { with: ["asset"] };
    const tableColumns = [];
    const fromFields = [];
    const assetApi = new Asset();
    const teamApi = new Team();
    const hostRegionApi = new hostRegion();
    const assetCategoryApi = new assetCategory();

    return {
      api,
      apiParams,
      tableColumns,
      fromFields,
      assetApi,
      teamApi,
      hostRegionApi,
      assetCategoryApi,
    };
  },

  async mounted() {
    try {
      await this.fetchStatisticsData();
    } catch (error) {
      console.error("Error during component mount:", error);
    } finally {
      this.load = false;
    }
  },
  data() {
    return {
      load: true,
      isFirstUpdate: false,
      isFlipped: false,
      isReadonly: false,
      newItem: { ip_address: null, asset_id: null },
      isAssigneeDisabled: false,
      teams: [],
      assets: ref([]),
      hostRegions: [],
      assetCategories: [],
      filters: {
        plugin_id: "",
        severity: "",
        owner_status: "",
        scanner_status: "",
        exploit: "",
        host_region_id: "",
        asset_category_id: "",
      },
      vulnerabilityOwnerStatus: [],
      vulnerabilityData: [],
      viewModal: false,
      changeOwnerStatusModal: false,
      statusOptions: [
        { name: this.$t('common.open'), id: 1 },
        { name: this.$t('common.in_progress'), id: 2 },
        { name: this.$t('common.closed'), id: 3 },
        { name: this.$t('common.over_due'), id: 4 },
      ],

      // Statistics data
      statisticsData: {
        totalVulnerabilities: 0,
        openVulnerabilities: 0,
        closedVulnerabilities: 0,
        inProgressVulnerabilities: 0,
        totalChangePercent: 0,
        openChangePercent: 80,
        closedChangePercent: 20,
        inProgressChangePercent: 0,
        totalChange: 0,
        inProgressChange: 0,
      },

      // Highcharts configurations
      criticalByDepartmentHighcharts: {},
      topPriorityHighcharts: {},
      severityStatusHighcharts: {},
      closureRateHighcharts: {},
      vulnerabilityFilters: [
        {
          title: this.$t("vulnerability.severity"),
          key: "severity",
          type: "integer",
          data: [
            { id: "1", name: this.$t("vulnerability.low") },
            { id: "2", name: this.$t("vulnerability.medium") },
            { id: "3", name: this.$t("vulnerability.high") },
            { id: "4", name: this.$t("vulnerability.informational") },
            { id: "5", name: this.$t("vulnerability.critical") },
          ],
          filterType: "filter",
        },
        {
          title: this.$t("vulnerability.owner_status"),
          key: "owner_status",
          type: "integer",
          data: [
            { id: "1", name: this.$t("common.open") },
            { id: "2", name: this.$t("common.in_progress") },
            { id: "3", name: this.$t("common.closed") },
            { id: "4", name: this.$t("common.over_due") },
          ],
          filterType: "filter",
        },
        {
          title: this.$t("vulnerability.scanner_status"),
          key: "scanner_status",
          type: "integer",
          data: [
            { id: "1", name: this.$t("common.open") },
            { id: "2", name: this.$t("common.in_progress") },
            { id: "3", name: this.$t("common.closed") },
            { id: "4", name: this.$t("common.over_due") },
          ],
          filterType: "filter",
        },
        {
          title: this.$t("vulnerability.exploit"),
          key: "exploit",
          type: "boolean",
          data: [
            { id: "1", name: this.$t("vulnerability.exploit") },
            { id: "0", name: this.$t("vulnerability.not_exploit") },
          ],
          filterType: "filter",
        },
        {
          title: this.$t("vulnerability.host_region"),
          key: "host_region_id",
          type: "string",
          data: "hostRegion",
          filterType: "filterWhereRelation[]",
        },
        {
          title: this.$t("vulnerability.asset_category"),
          key: "asset_category_id",
          type: "string",
          data: "assetCategory",
          filterType: "filterWhereRelation[]",
        },
      ],
      formatDateShort,
      htmlToTextRegex,
    };
  },

  created() {
    this.loadSelectsData();

    this.tableColumns = [
      {
        id: "plugin_id",
        title: this.$t("vulnerability.plugin_id"),
        data: "plugin_id",
        defaultContent: "N/A",
      },
      {
        id: "plugin_name",
        title: this.$t("vulnerability.plugin_name"),
        data: "plugin_name",
        defaultContent: "N/A",
      },
      {
        id: "cve",
        title: this.$t("vulnerability.cve"),
        data: "cve",
        defaultContent: "N/A",
      },
      {
        id: "asset",
        title: this.$t("vulnerability.asset"),
        data: "asset.name",
        defaultContent: "N/A",
      },
      {
        id: "ip_address",
        title: this.$t("vulnerability.ip_address"),
        data: "ip_address",
        defaultContent: "N/A",
      },
      {
        id: "severity",
        title: this.$t("vulnerability.severity"),
        data: "severity",
        defaultContent: "N/A",
      },
      {
        id: "dns_name",
        title: this.$t("vulnerability.dns_name"),
        data: "dns_name",
        defaultContent: "N/A",
      },
      {
        id: "netbios_name",
        title: this.$t("vulnerability.netbios_name"),
        data: "netbios_name",
        defaultContent: "N/A",
      },
      {
        id: "owner_status",
        title: this.$t("vulnerability.owner_status"),
        data: "owner_status",
        defaultContent: "N/A",
      },
      {
        id: "scanner_status",
        title: this.$t("vulnerability.scanner_status"),
        data: "scanner_status",
        defaultContent: "N/A",
      },
      {
        id: "port",
        title: this.$t("vulnerability.port"),
        data: "port",
        defaultContent: "N/A",
      },
      {
        id: "exploit",
        title: this.$t("vulnerability.exploit"),
        data: "exploit",
        defaultContent: "N/A",
      }
    ];

    this.fromFields = [
      {
        name: "plugin_id",
        label: this.$t("vulnerability.plugin_id"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_plugin_id"),
      },
      {
        name: "plugin_name",
        label: this.$t("vulnerability.plugin_name"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_plugin_name"),
      },
      {
        name: "cve",
        label: this.$t("vulnerability.cve"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_cve"),
      },
      {
        name: "netbios_name",
        label: this.$t("vulnerability.netbios_name"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_netbios_name"),
      },
      {
        name: "dns_name",
        label: this.$t("vulnerability.dns_name"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_dns_name"),
      },
      {
        name: "port",
        label: this.$t("vulnerability.port"),
        type: "number",
        rules: "required|number",
        col: 6,
        placeholder: this.$t("vulnerability.enter_port"),
      },
      {
        type: "options",
        name: "ip_address",
        label: this.$t("vulnerability.ip_address"),
        options: [],
        optionLabel: "id",
        col: 6,
        rules: "required",
        placeholder: this.$t("vulnerability.select_ip_address"),
      },
      {
        name: "asset_id",
      },
      {
        type: "team-select",
        name: "team_ids",
        label: this.$t("asset.teams"),
        // options: "Team",
        // optionLabel: "name",
        col: 6,
        rules: "required",
        multiple: true,
        placeholder: this.$t("asset.select_teams"),
      },
      {
        type: "options",
        name: "severity",
        label: this.$t("vulnerability.severity"),
        options: [
          { id: 1, name: this.$t("vulnerability.low") },
          { id: 2, name: this.$t("vulnerability.medium") },
          { id: 3, name: this.$t("vulnerability.high") },
          { id: 4, name: this.$t("vulnerability.informational") },
          { id: 5, name: this.$t("vulnerability.critical") },
        ],
        optionLabel: "name",
        col: 6,
        rules: "required",
        placeholder: this.$t("vulnerability.select_severity"),
      },
      {
        name: "synopsis",
        label: this.$t("vulnerability.synopsis"),
        type: "textarea",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_synopsis"),
      },
      {
        name: "description",
        label: this.$t("common.description"),
        type: "textarea",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_description"),
      },
      {
        name: "solution",
        label: this.$t("vulnerability.solution"),
        type: "textarea",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_solution"),
      },
      {
        name: "plugin_output",
        label: this.$t("vulnerability.plugin_output"),
        type: "textarea",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_plugin_output"),
      },
      {
        name: "protocol",
        label: this.$t("vulnerability.protocol"),
        type: "text",
        rules: "required",
        col: 6,
        placeholder: this.$t("vulnerability.enter_protocol"),
      },
      {
        name: "first_discovered",
        label: this.$t("vulnerability.first_discovered"),
        rules: "date",
        type: "date",
        col: 6,
        placeholder: this.$t("vulnerability.select_first_discovered"),
      },
      {
        name: "last_observed",
        label: this.$t("vulnerability.last_observed"),
        rules: "date",
        type: "date",
        col: 6,
        placeholder: this.$t("vulnerability.select_last_observed"),
      },
      {
        name: "plugin_publication_date",
        label: this.$t("vulnerability.plugin_publication_date"),
        rules: "date",
        type: "date",
        col: 6,
        placeholder: this.$t("vulnerability.select_plugin_publication_date"),
      },
      {
        name: "plugin_modification_date",
        label: this.$t("vulnerability.plugin_modification_date"),
        rules: "date",
        type: "date",
        col: 6,
        placeholder: this.$t("vulnerability.select_plugin_modification_date"),
      },
      {
        name: "exploit",
        label: this.$t("vulnerability.exploit"),
        type: "checkbox",
        rules: "required",
        col: 6,
      },
    ];
  },

  methods: {
    async fetchStatisticsData() {
      try {
        // Load teams data first
        await this.loadSelectsData();

        const allVulnerabilities = await this.api.getAll({
          with: ["asset"],
        });

        console.log("Fetched vulnerabilities:", allVulnerabilities);
        console.log("Teams mapping:", this.teams);

        // Calculate basic statistics
        let totalVulnerabilities = allVulnerabilities.length;
        let openVulnerabilities = 0;
        let closedVulnerabilities = 0;
        let inProgressVulnerabilities = 0;
        let criticalVulnerabilities = 0;
        let highVulnerabilities = 0;

        // Data structures for charts
        const teamCriticalMap = {};
        const topPriorityVulnerabilities = [];
        const severityStatusMap = {
          1: { open: 0, in_progress: 0, closed: 0, overdue: 0 }, // Low
          2: { open: 0, in_progress: 0, closed: 0, overdue: 0 }, // Medium
          3: { open: 0, in_progress: 0, closed: 0, overdue: 0 }, // High
          4: { open: 0, in_progress: 0, closed: 0, overdue: 0 }, // Informational
          5: { open: 0, in_progress: 0, closed: 0, overdue: 0 }, // Critical
        };

        // Closure rate tracking (last 3 months)
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        const closureByMonth = {};

        allVulnerabilities.forEach((vuln) => {
          // Count by severity
          if (vuln.severity === 5) criticalVulnerabilities++;
          if (vuln.severity === 3) highVulnerabilities++;

          // Count by status
          if (vuln.owner_status === 1) openVulnerabilities++;
          if (vuln.owner_status === 2) inProgressVulnerabilities++;
          if (vuln.owner_status === 3) closedVulnerabilities++;

          // Team-wise critical vulnerabilities
          if (vuln.severity === 5) {
            if (vuln.team_ids && Array.isArray(vuln.team_ids) && vuln.team_ids.length > 0) {
              // Count for each team the vulnerability is assigned to
              vuln.team_ids.forEach((teamId) => {
                const teamName = this.teams[teamId] || 'Unknown Team';
                teamCriticalMap[teamName] = (teamCriticalMap[teamName] || 0) + 1;
              });
            } else {
              // Count unassigned critical vulnerabilities
              teamCriticalMap['Unassigned'] = (teamCriticalMap['Unassigned'] || 0) + 1;
            }
          }

          // Severity and status mapping
          const statusKey =
            vuln.owner_status === 1
              ? "open"
              : vuln.owner_status === 2
              ? "in_progress"
              : vuln.owner_status === 3
              ? "closed"
              : "overdue";

          if (severityStatusMap[vuln.severity]) {
            severityStatusMap[vuln.severity][statusKey]++;
          }

          // Top priority vulnerabilities (Critical + High, not closed)
          if ((vuln.severity === 5 || vuln.severity === 3) && vuln.owner_status !== 3) {
            topPriorityVulnerabilities.push({
              name: vuln.plugin_name || vuln.cve || "Unknown",
              severity: vuln.severity,
              count: 1,
              cve: vuln.cve,
            });
          }

          // Closure rate calculation
          if (vuln.owner_status === 3 && vuln.updated_at) {
            const closedDate = new Date(vuln.updated_at);
            if (closedDate >= threeMonthsAgo) {
              const monthKey = `${closedDate.getFullYear()}-${String(
                closedDate.getMonth() + 1
              ).padStart(2, "0")}`;
              closureByMonth[monthKey] = (closureByMonth[monthKey] || 0) + 1;
            }
          }
        });

        // Aggregate top priority vulnerabilities by CVE
        const aggregatedPriority = {};
        topPriorityVulnerabilities.forEach((vuln) => {
          const key = vuln.cve || vuln.name;
          if (aggregatedPriority[key]) {
            aggregatedPriority[key].count++;
          } else {
            aggregatedPriority[key] = { ...vuln };
          }
        });

        const topPriorityData = Object.values(aggregatedPriority)
          .sort((a, b) => b.count - a.count)
          .slice(0, 10);

        // Calculate percentage changes (using mock data for now, can be enhanced with historical comparison)
        const totalChangePercent = totalVulnerabilities > 0 ? Math.round((totalVulnerabilities / 10) * 10) : 0;
        const openChangePercent = openVulnerabilities > 0 ? 80 : 0;
        const closedChangePercent = closedVulnerabilities > 0 ? 20 : 0;
        const inProgressChangePercent = inProgressVulnerabilities > 0 ? 0 : 0;

        this.statisticsData = {
          totalVulnerabilities,
          openVulnerabilities,
          closedVulnerabilities,
          inProgressVulnerabilities,
          totalChangePercent,
          openChangePercent,
          closedChangePercent,
          inProgressChangePercent,
          totalChange: totalChangePercent,
          inProgressChange: inProgressChangePercent,
        };

        this.buildCharts(
          teamCriticalMap,
          topPriorityData,
          severityStatusMap,
          closureByMonth
        );
      } catch (error) {
        console.error("Error in fetchStatisticsData:", error);
        throw error;
      }
    },

    buildCharts(
      teamCriticalMap,
      topPriorityData,
      severityStatusMap,
      closureByMonth
    ) {
      try {
        // 1. Critical Vulnerabilities by Team (Column Chart with 3D)
        const hasTeamData = Object.keys(teamCriticalMap).length > 0;

        this.criticalByDepartmentHighcharts = {
          chart: {
            type: "column",
            height: 350,
            options3d: {
              enabled: true,
              alpha: 10,
              beta: 15,
              depth: 50,
            },
          },
          title: { text: null },
          xAxis: {
            categories: hasTeamData ? Object.keys(teamCriticalMap) : ['No Data'],
            title: {
              text: this.$t("vulnerability.team") || "Team",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
            labels: {
              style: { fontSize: "11px" },
              rotation: -45,
            },
          },
          yAxis: {
            min: 0,
            title: {
              text: this.$t("vulnerability.critical_count") || "Critical Vulnerabilities",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
          },
          tooltip: {
            valueSuffix: " vulnerabilities",
            style: { fontSize: "14px" },
          },
          plotOptions: {
            column: {
              depth: 25,
              dataLabels: {
                enabled: true,
                style: { fontSize: "12px", fontWeight: "bold" },
              },
              borderRadius: 5,
            },
          },
          legend: { enabled: false },
          series: [
            {
              name: this.$t("vulnerability.critical") || "Critical",
              data: hasTeamData ? Object.values(teamCriticalMap) : [0],
              color: {
                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                stops: [
                  [0, "#8D1F1F"],
                  [1, "#dc3545"],
                ],
              },
            },
          ],
        };

        // 2. Top Priority Vulnerabilities (Horizontal Bar Chart)
        const hasTopPriorityData = topPriorityData.length > 0;

        this.topPriorityHighcharts = {
          chart: {
            type: "bar",
            height: 350,
          },
          title: { text: null },
          xAxis: {
            categories: hasTopPriorityData
              ? topPriorityData.map((v) => v.name.substring(0, 30))
              : ['No Priority Vulnerabilities'],
            title: { text: null },
            labels: { style: { fontSize: "11px" } },
          },
          yAxis: {
            min: 0,
            title: {
              text: this.$t("vulnerability.occurrences") || "Occurrences",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
          },
          tooltip: {
            valueSuffix: " occurrences",
            style: { fontSize: "14px" },
          },
          plotOptions: {
            bar: {
              dataLabels: {
                enabled: true,
                style: { fontSize: "12px", fontWeight: "bold" },
              },
              borderRadius: 5,
            },
          },
          legend: { enabled: false },
          series: [
            {
              name: this.$t("vulnerability.priority") || "Priority",
              data: hasTopPriorityData
                ? topPriorityData.map((v) => ({
                    y: v.count,
                    color: v.severity === 5 ? "#8D1F1F" : "#EED3D3",
                  }))
                : [{ y: 0, color: "#cccccc" }],
            },
          ],
        };

        // 3. Vulnerability Statistics by Severity and Status (Stacked Column)
        const severityLabels = {
          1: this.$t("vulnerability.low") || "Low",
          2: this.$t("vulnerability.medium") || "Medium",
          3: this.$t("vulnerability.high") || "High",
          4: this.$t("vulnerability.informational") || "Informational",
          5: this.$t("vulnerability.critical") || "Critical",
        };

        this.severityStatusHighcharts = {
          chart: {
            type: "column",
            height: 400,
          },
          title: { text: null },
          xAxis: {
            categories: Object.keys(severityStatusMap).map(
              (k) => severityLabels[k]
            ),
            title: {
              text: this.$t("vulnerability.severity") || "Severity",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
          },
          yAxis: {
            min: 0,
            title: {
              text: this.$t("vulnerability.count") || "Count",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
            stackLabels: {
              enabled: true,
              style: { fontWeight: "bold", color: "gray" },
            },
          },
          tooltip: {
            headerFormat: "<b>{point.x}</b><br/>",
            pointFormat: "{series.name}: {point.y}<br/>Total: {point.stackTotal}",
            style: { fontSize: "14px" },
          },
          plotOptions: {
            column: {
              stacking: "normal",
              dataLabels: {
                enabled: false,
              },
              borderRadius: 3,
            },
          },
          legend: {
            align: "center",
            verticalAlign: "bottom",
            layout: "horizontal",
          },
          series: [
            {
              name: this.$t("common.open") || "Open",
              data: Object.values(severityStatusMap).map((s) => s.open),
              color: "#2c1bc4",
            },
            {
              name: this.$t("common.in_progress") || "In Progress",
              data: Object.values(severityStatusMap).map((s) => s.in_progress),
              color: "#e28f0b",
            },
            {
              name: this.$t("common.closed") || "Closed",
              data: Object.values(severityStatusMap).map((s) => s.closed),
              color: "#2f9826",
            },
            {
              name: this.$t("common.over_due") || "Overdue",
              data: Object.values(severityStatusMap).map((s) => s.overdue),
              color: "#8D1F1F",
            },
          ],
        };

        // 4. Vulnerability Closure Rate Over Last 3 Months (Area Spline Chart)
        const sortedMonths = Object.keys(closureByMonth).sort();
        const last3Months = [];
        const currentDate = new Date();

        for (let i = 2; i >= 0; i--) {
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
          last3Months.push({
            month: monthKey,
            count: closureByMonth[monthKey] || 0,
          });
        }

        this.closureRateHighcharts = {
          chart: {
            type: "areaspline",
            height: 350,
          },
          title: { text: null },
          xAxis: {
            categories: last3Months.map((m) => {
              const [year, month] = m.month.split("-");
              const date = new Date(year, month - 1);
              return date.toLocaleDateString("en-US", {
                month: "short",
                year: "numeric",
              });
            }),
            title: {
              text: this.$t("vulnerability.month") || "Month",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
          },
          yAxis: {
            min: 0,
            title: {
              text: this.$t("vulnerability.closed_count") || "Closed Vulnerabilities",
              style: { fontSize: "14px", fontWeight: "bold" },
            },
          },
          tooltip: {
            valueSuffix: " closed",
            style: { fontSize: "14px" },
          },
          plotOptions: {
            areaspline: {
              fillOpacity: 0.5,
              marker: {
                enabled: true,
                radius: 5,
              },
              dataLabels: {
                enabled: true,
                style: { fontSize: "12px", fontWeight: "bold" },
              },
            },
          },
          legend: { enabled: false },
          series: [
            {
              name: this.$t("vulnerability.closed") || "Closed",
              data: last3Months.map((m) => m.count),
              color: {
                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                stops: [
                  [0, "#28a745"],
                  [1, "#d6eed3"],
                ],
              },
            },
          ],
        };
      } catch (error) {
        console.error("Error in buildCharts:", error);
      }
    },

    async handleQualysImport() {
      console.log("ImportFromQualys Funtion Is Working");
      const response = await this.api.vulnerabilityImportFromQualys()
      console.log(response);

    },

    async changeAssets(ipAddress) {
      if (!this.isFirstUpdate) {
        this.assets = [];
        this.newItem.asset_id = null;
      }

      this.isFirstUpdate = false;

      if (ipAddress) {
        this.assets = await this.assetApi.getAssetsByIp(ipAddress);
      }
    },

    openForm() {
      this.isFlipped = true;
    },

    closeForm() {
      this.isFlipped = false;
      this.$refs.table.refreshTable();
      this.newItem = {};
    },

    editItem(data) {
      this.isFirstUpdate = true;
      this.newItem = data;
      this.isFlipped = true;
    },

    async loadSelectsData() {
      try {
        const teamsResponse = await this.teamApi.getAll({ select: "id|name" });
        this.fromFields.find((field) => field.name === "team_ids").options =
          teamsResponse;
        this.teams = teamsResponse.reduce((map, team) => {
          map[team.id] = team.name;
          return map;
        }, {});

        const assetsIpsResponse = await this.assetApi.getAll({
          select: "ip_address",
        });

        const uniqueData = Array.from(
          new Set(assetsIpsResponse.map((value) => value.ip_address))
        ).map((ip) => ({ id: ip }));

        this.fromFields.find((field) => field.name === "ip_address").options =
          uniqueData;

        const hostRegionsResponse = await this.hostRegionApi.getAll({
          select: "id|name",
        });
        this.hostRegions = hostRegionsResponse.reduce((map, hostRegion) => {
          map[hostRegion.id] = hostRegion.name;
          return map;
        }, {});

        const assetCategoriesResponse = await this.assetCategoryApi.getAll({
          select: "id|name",
        });
        this.assetCategories = assetCategoriesResponse.reduce(
          (map, assetCategory) => {
            map[assetCategory.id] = assetCategory.name;
            return map;
          },
          {}
        );
      } catch (error) {
        console.error("Failed to load data:", error);
      }
    },

    openOwnerStatusModal(selectedRow) {
      console.log("/*--*/-**-selectedRow/*-*/-*-*", selectedRow);
      this.vulnerabilityOwnerStatus = { ...selectedRow };
      this.changeOwnerStatusModal = true;
    },

    closeOwnerStatusModal() {
      this.changeOwnerStatusModal = false;
    },

    async changeOwnerStatus(vulnerabilityData) {
      try {
        const response = await this.api.update(vulnerabilityData);

        if (response.status == 'success') {
          this.$refs.table.refreshTable();
          this.closeOwnerStatusModal();
          this.api.poup(response, this.$t('vulnerability.owner_status_changed'));
        }

      } catch (error) {
        console.error("Error updating owner status:", error);
      }
    },

    setVulnerabilityData(item) {
      this.vulnerabilityData = item;
      this.viewModal = true;
      console.log("this.teams", this.teams);
      console.log("this.vulnerabilityData", this.vulnerabilityData);
    },

    getOwnerStatusClass(status) {
      switch (status) {
        case 1:
          return 'status open'
        case 2:
          return 'status in_progress'
        case 3:
          return 'status closed'
        case 4:
          return 'status overdue'
        default:
          return 'status unknown'
      }
    },

    getOwnerStatusLabel(status) {
      switch (status) {
        case 1:
          return this.$t('common.open')
        case 2:
          return this.$t('common.in_progress')
        case 3:
          return this.$t('common.closed')
        case 4:
          return this.$t('common.over_due')
        default:
          return this.$t('common.unknown')
      }
    },

    handleOwnerStatusClick(item) {
      // Only allow click for open or in_progress
      if ([1, 2].includes(item.owner_status)) {
        this.openOwnerStatusModal(item)
      }
    },
    getSeverityClass(severity) {
      switch (severity) {
        case 1:
          return 'severity low'
        case 2:
          return 'severity medium'
        case 3:
          return 'severity high'
        case 4:
          return 'severity informational'
        case 5:
          return 'severity critical'
        default:
          return 'severity unknown'
      }
    },

    getSeverityLabel(severity) {
      switch (severity) {
        case 1:
          return this.$t('vulnerability.low')
        case 2:
          return this.$t('vulnerability.medium')
        case 3:
          return this.$t('vulnerability.high')
        case 4:
          return this.$t('vulnerability.informational')
        case 5:
          return this.$t('vulnerability.critical')
        default:
          return this.$t('vulnerability.unknown')
      }
    }
  },
  watch: {
    "newItem.ip_address"(value) {
      this.changeAssets(value);
    },

    filters: {
      deep: true,
      handler(newFilter) {
        const filtersObject = [];
        this.apiParams.filterWhereRelation = [];
        if (newFilter.owner_status) {
          filtersObject.push(
            `owner_status|${newFilter.owner_status}-integer|=`
          );
        }
        if (newFilter.scanner_status) {
          filtersObject.push(
            `scanner_status|${newFilter.scanner_status}-integer|=`
          );
        }
        if (newFilter.severity) {
          filtersObject.push(`severity|${newFilter.severity}-integer|=`);
        }
        if (newFilter.exploit) {
          filtersObject.push(`exploit|${newFilter.exploit}-boolean|=`);
        }
        if (newFilter.host_region_id) {
          this.apiParams.filterWhereRelation = [`asset@host_region_id|${newFilter.host_region_id}|=`];
        }
        if (newFilter.asset_category_id) {
          this.apiParams.filterWhereRelation = [`asset@asset_category_id|${newFilter.asset_category_id}|=`];
        }

        this.apiParams.filter = filtersObject.join("&&");
        this.$refs.table.refreshTable();
      },
    },
  },
};
</script>


<style scoped>
/* Statistics Styles */
.statistics-content {
  padding: 30px;
  background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
  min-height: 100vh;
}

/* New Metric Card Styles */
.metric-card-new {
  display: flex;
  align-items: center;
  padding: 20px;
  background: #ffffff;
  border-radius: 12px;
  border: 1px solid #e8e8e8;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.metric-card-new::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #6e3894 0%, #a87cd2 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.metric-card-new:hover {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
  transform: translateY(-3px);
}

.metric-card-new:hover::before {
  opacity: 1;
}

.metric-icon-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  margin-left: 0px;
  flex-shrink: 0;
}

.metric-icon-circle i {
  font-size: 24px;
  color: #ffffff;
}

.metric-icon-circle.bg-gray {
  background-color: #6c757d;
  border: 3px solid #5a6268;
}

.metric-icon-circle.bg-green {
  background-color: #28a745;
  border: 3px solid #218838;
}

.metric-icon-circle.bg-red {
  background-color: #dc3545;
  border: 3px solid #c82333;
}

.metric-icon-circle.bg-light-gray {
  background-color: #e0e0e0;
  border: 3px solid #d0d0d0;
}

.metric-icon-circle.bg-light-gray i {
  color: #6c757d;
}

.metric-details {
  flex: 1;
}

.metric-number {
  font-size: 2rem;
  font-weight: bold;
  margin: 0 0 5px 0;
  line-height: 1;
  color: #333;
}

.metric-number.text-green {
  color: #28a745;
}

.metric-number.text-red {
  color: #dc3545;
}

.metric-number.text-gray {
  color: #a0a0a0;
}

.metric-title {
  font-size: 0.875rem;
  color: #666;
  margin: 0 0 8px 0;
  font-weight: 400;
}

.metric-change {
  font-size: 0.875rem;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 4px;
  display: inline-block;
}

.metric-change.positive {
  color: #28a745;
  background-color: #d4edda;
}

.metric-change.negative {
  color: #dc3545;
  background-color: #f8d7da;
}

.chart-container {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  min-height: 350px;
}

.chart-title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 15px;
  color: #333;
  /* border-bottom: 2px solid #6e3894; */
  padding-bottom: 10px;
}

.title_span {
  display: inline-flex;
  align-items: center;
  width: max-content;
  height: 20px;
  opacity: 1;
  border-radius: 10px;
  padding: 11px 9px;
  gap: 8px;
  background: #d0b5e3;
  font-size: 12px;
  color: #6e3894;
}

/* START Status */
.exploit,
.severity {
  display: inline-flex;
  align-items: center;
  width: max-content;
  height: 20px;
  opacity: 1;
  border-radius: 10px;
  padding: 8px 9px;
  gap: 8px;
  font-size: 11px;
  font-weight: 500;
}

.status {
  display: inline-flex;
  align-items: center;
  width: max-content;
  height: 20px;
  opacity: 1;
  border-radius: 10px;
  padding: 8px 9px;
  gap: 8px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
}

.status.open {
  background: #b3c0eb;
  color: #2c1bc4;
}

.exploit.exploited,
.status.closed {
  background: #d6eed3;
  color: #2f9826;
}

.exploit.not-exploited,
.status.overdue {
  background: #8D1F1F;
  color: #FFFFFF;
}

.status.in_progress {
  background: #ebd3b3;
  color: #e28f0b;
}

.status.unknown {
  background: #e0e0e0;
  color: #616161;
}


.severity.low {
  background: #B6CAAE;
  color: #255F0B;
}

.severity.medium {
  background: #F3EAD1;
  color: #C4951B;
}

.severity.high {
  background: #EED3D3;
  color: #A92525;
}

.severity.critical {
  background: #8D1F1F;
  color: #FFFFFF;
}

/* END status */

.action-list-item {
  padding: 4px 15px !important;
  transition: all 0.2s ease !important;
  cursor: pointer !important;
  border-radius: 0 !important;
  margin: 5px !important;
}

.action-list-item:hover {
  background-color: #f5f5f5 !important;
  border: 2px solid #6e3894 !important;
  border-radius: 10px !important;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
  flex: 1;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #D0B5E3;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #43235C;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.3px;
  flex-shrink: 0;
  cursor: pointer;
}

.user-fullname {
  font-size: 14px;
  font-weight: 600;
  color: #000000;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 960px) {
  .v-dialog>.v-overlay__content {
    width: calc(80% - 48px);
  }
}
[dir="rtl"] .metric-icon-circle {
    margin-left: 15px;
    margin-right: 0px;
}
[dir="rtl"] .metric-details {
    text-align: end;
}

</style>
