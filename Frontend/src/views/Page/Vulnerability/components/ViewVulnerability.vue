<template>
  <Modal :model-value="viewModal" @update:modelValue="$emit('update:viewModal', $event)"
    :title="$t('vulnerability.view_vulnerability')" size="xlarge" :show-footer="true" :has-submit="false"
    @close="$emit('close')">
    <div class="container-fluid">
      <div class="row g-3">
        <!-- Basic Info -->
        <div class="col-md-4" v-for="(field, index) in basicFields" :key="index">
          <span class="fw-bold">{{ $t(field.label) }}</span>
          <p>{{ field.value }}</p>
        </div>

        <!-- Severity -->
        <div class="col-md-4">
          <span class="fw-bold">{{ $t('vulnerability.severity') }}</span>
          <p>
            <span :class="getSeverityClass(vulnerabilityData.severity)">
              {{ getSeverityLabel(vulnerabilityData.severity) }}
            </span>
          </p>
        </div>

        <!-- Exploit -->
        <div class="col-md-4">
          <span class="fw-bold">{{ $t('vulnerability.exploit') }}</span>
          <p>
            <span :class="vulnerabilityData.exploit ? 'exploit exploited' : 'exploit not-exploited'">
              {{
                vulnerabilityData.exploit
                  ? $t('vulnerability.exploit')
                  : $t('vulnerability.not_exploit')
              }}
            </span>
          </p>
        </div>

        <!-- Owner Status -->
        <div class="col-md-4">
          <span class="fw-bold">{{ $t('vulnerability.owner_status') }}</span>
          <p>
            <span :class="getOwnerStatusClass(vulnerabilityData.owner_status)"
              @click.prevent="handleOwnerStatusClick(vulnerabilityData)">
              {{ getOwnerStatusLabel(vulnerabilityData.owner_status) }}
            </span>
          </p>
        </div>

        <!-- Text Fields -->
        <div class="col-md-4" v-for="(field, i) in textFields" :key="'text-' + i">
          <span class="fw-bold">{{ $t(field.label) }}</span>
          <p>{{ stripHtml(field.value) }}</p>
        </div>

        <!-- Dates -->
        <div class="col-md-4" v-for="(field, i) in dateFields" :key="'date-' + i">
          <span class="fw-bold">{{ $t(field.label) }}</span>
          <p>{{ formatDate(field.value) }}</p>
        </div>

        <!-- Teams -->
        <div class="col-md-8">
          <span class="fw-bold">{{ $t('team.teams') }}</span>
          <p>
            {{
              vulnerabilityData?.team_ids?.length && Object.keys(teams).length
                ? vulnerabilityData.team_ids
                  .map((id) => teams[id])
                  .filter((name) => name)
                  .join(', ') || $t('common.na')
                : $t('common.na')
            }}
          </p>
        </div>
      </div>
    </div>

    <template #footer>
      <button class="btn btn-secondary" @click="$emit('close')">
        {{ $t('common.close') }}
      </button>
    </template>
  </Modal>
</template>

<script>
import Modal from "@/components/Modal.vue";

export default {
  components: { Modal },
  props: {
    viewModal: Boolean,
    vulnerabilityData: Object,
    formatDate: Function,
    stripHtml: Function,
    teams: Object,
  },
  computed: {
    basicFields() {
      return [
        { label: "vulnerability.plugin_id", value: this.vulnerabilityData.plugin_id },
        { label: "vulnerability.plugin_name", value: this.vulnerabilityData.plugin_name },
        { label: "vulnerability.cve", value: this.vulnerabilityData.cve },
        { label: "vulnerability.netbios_name", value: this.vulnerabilityData.netbios_name },
        { label: "vulnerability.dns_name", value: this.vulnerabilityData.dns_name },
        { label: "vulnerability.ip_address", value: this.vulnerabilityData.ip_address },
        { label: "vulnerability.asset", value: this.vulnerabilityData?.asset?.name },
        { label: "vulnerability.port", value: this.vulnerabilityData.port },
        { label: "vulnerability.protocol", value: this.vulnerabilityData.protocol },
      ];
    },
    textFields() {
      return [
        { label: "vulnerability.synopsis", value: this.vulnerabilityData.synopsis },
        { label: "vulnerability.description", value: this.vulnerabilityData.description },
        { label: "vulnerability.solution", value: this.vulnerabilityData.solution },
        { label: "vulnerability.plugin_output", value: this.vulnerabilityData.plugin_output },
      ];
    },
    dateFields() {
      return [
        { label: "vulnerability.first_discovered", value: this.vulnerabilityData.first_discovered },
        { label: "vulnerability.last_observed", value: this.vulnerabilityData.last_observed },
        { label: "vulnerability.plugin_publication_date", value: this.vulnerabilityData.plugin_publication_date },
        { label: "vulnerability.plugin_modification_date", value: this.vulnerabilityData.plugin_modification_date },
        { label: "vulnerability.scanner_status", value: this.vulnerabilityData.scanner_status },
        { label: "common.created_at", value: this.vulnerabilityData.created_at },
      ];
    },
  },
  methods: {
    /** Same logic from your table */
    getOwnerStatusClass(status) {
      switch (status) {
        case 1: return "status open";
        case 2: return "status in_progress";
        case 3: return "status closed";
        case 4: return "status overdue";
        default: return "status unknown";
      }
    },
    getOwnerStatusLabel(status) {
      switch (status) {
        case 1: return this.$t("common.open");
        case 2: return this.$t("common.in_progress");
        case 3: return this.$t("common.closed");
        case 4: return this.$t("common.over_due");
        default: return this.$t("common.unknown");
      }
    },
    handleOwnerStatusClick(item) {
      if ([1, 2].includes(item.owner_status)) {
        this.$emit("change-status", item); // optional custom event
      }
    },
    getSeverityClass(severity) {
      switch (severity) {
        case 1: return "severity low";
        case 2: return "severity medium";
        case 3: return "severity high";
        case 4: return "severity informational";
        case 5: return "severity critical";
        default: return "severity unknown";
      }
    },
    getSeverityLabel(severity) {
      switch (severity) {
        case 1: return this.$t("vulnerability.low");
        case 2: return this.$t("vulnerability.medium");
        case 3: return this.$t("vulnerability.high");
        case 4: return this.$t("vulnerability.informational");
        case 5: return this.$t("vulnerability.critical");
        default: return this.$t("vulnerability.unknown");
      }
    },
  },
};
</script>

<style scoped>
.exploit,
.status,
.severity {
  display: inline-flex;
  align-items: center;
  width: max-content;
  border-radius: 10px;
  padding: 8px 9px;
  font-size: 11px;
  font-weight: 500;
  height: 20px;
}

.status {
  cursor: pointer;
}

/* Exploit */
.exploit.exploited {
  background: #d6eed3;
  color: #2f9826;
}

.exploit.not-exploited {
  background: #8d1f1f;
  color: #fff;
}

/* Status */
.status.open {
  background: #b3c0eb;
  color: #2c1bc4;
}

.status.in_progress {
  background: #ebd3b3;
  color: #e28f0b;
}

.status.closed {
  background: #d6eed3;
  color: #2f9826;
}

.status.overdue {
  background: #8d1f1f;
  color: #fff;
}

.status.unknown {
  background: #e0e0e0;
  color: #616161;
}

/* Severity */
.severity.low {
  background: #b6caae;
  color: #255f0b;
}

.severity.medium {
  background: #f3ead1;
  color: #c4951b;
}

.severity.high {
  background: #eed3d3;
  color: #a92525;
}

.severity.critical {
  background: #8d1f1f;
  color: #fff;
}

.severity.informational {
  background: #b2d6f1;
  color: #144b6f;
}
</style>
