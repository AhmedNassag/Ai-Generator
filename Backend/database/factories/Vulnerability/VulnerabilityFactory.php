<?php

namespace Database\Factories\Vulnerability;

use App\Models\Asset\Asset;
use App\Models\Team\Team;
use App\Models\Vulnerability\Vulnerability;
use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Arr;

class VulnerabilityFactory extends Factory
{
    protected $model = Vulnerability::class;

    public function definition()
    {
        $asset = Asset::all()->select(['_id','ip_address'])->shuffle()->take(1)->first();

        return [
            'plugin_id' => $this->faker->uuid,
            'plugin_name' => $this->faker->sentence(3),
            'cve' => 'CVE-' . $this->faker->year . '-' . $this->faker->randomNumber(6),
            'netbios_name' => $this->faker->domainWord,
            'dns_name' => $this->faker->domainName,
            'ip_address' => $asset['ip_address'],
            'asset_id' => $asset['_id'],
            'port' => $this->faker->numberBetween(1, 65535),
            'protocol' => Arr::random(['TCP', 'UDP', 'ICMP']),
            'severity' => $this->faker->numberBetween(1, 5), // 1: critical, 5: informational
            'exploit' => $this->faker->boolean,
            'synopsis' => $this->faker->sentence,
            'description' => $this->faker->paragraph,
            'solution' => $this->faker->paragraph,
            'plugin_output' => $this->faker->text(200),
            'first_discovered' => $this->faker->dateTimeBetween('-1 year', 'now'),
            'last_observed' => $this->faker->dateTimeBetween('-6 months', 'now'),
            'plugin_publication_date' => $this->faker->dateTimeBetween('-5 years', '-1 year'),
            'plugin_modification_date' => $this->faker->dateTimeBetween('-1 year', 'now'),
            'owner_status' => $this->faker->numberBetween(1, 4), // 1: open, 4: over-due
            'scanner_status' => null
        ];
    }

    public function configure()
    {
        return $this->afterCreating(function (Vulnerability $vulnerability) {
            // Fetch all teams and take 2 random teams
            $teamIds = Team::all()->pluck('_id')->shuffle()->take(2)->toArray();

            // Ensure 'asset_ids' field on Team is always an array
            Team::whereIn('_id', $teamIds)->each(function ($team) use ($vulnerability) {
                if (!is_array($team->vulnerability_ids)) {
                    $team->vulnerability_ids = []; // Make sure it's an array
                }
                $team->vulnerability_ids = array_merge($team->vulnerability_ids, [$vulnerability->_id]);
                $team->save();
            });

            // Attach teams to the relationship
            $vulnerability->teams()->attach($teamIds);
        });
    }
}
